# Продам душу composer'у, недорого.

Пришла пора осваивать composer. Хотя композер навязывает мне жесткую схему 
хранения пакетов, навязывает свой собственный автолод, но с этими ограничениями 
довольно просто смириться.

## А что у нас есть?

А у нас есть проект. Не особенно большой, в меру красивый. Развивался он долго, 
трудно, с тестами, бубнами и, местами, с блекждеком. Из-за особенностей развития,
в проекте скопились разные тестовые недоразумения, недописанная документация, 
оказавшиеся не очень то и нужными фенечки, и так далее... все это любовно 
складывается в гит, образуя живописные кучки добра, которое вот обязательно 
когда-нибудь пригодится...

К счастью, проект оказался кому-то нужен. Хотя бы и самому себе в другом проекте.
Этому кому-то показалось разумным применить часть проекта у себя. Причем, ему не 
очень то нужен весь, иногда довольно странный, поток сознания, а нужны четко 
определенные классы, возможно, с кусочком вменяемой документации. И все.

## Чем не устраивает то, что есть сейчас?

Достаточно посмотреть на дистрибуцию пакета twig/twig, чтобы увидеть проблемы 
слишком простого обращения с композером. Весь устанавливаемый пакет занимает 
1.3м, в то время как действительно полезными оказываются только <500к из каталога
twig/twig/lib.

## Что делать?

У композера не густо с директивами "давай сложим в корзинку вот такие файлы, 
а все остальное выкинем". Зато композер умеет работать с дистрибутами из 
архивов. Так что автору проекта достаточно складировать в архив необходимые 
для "библиотеки" файлы и дело в шляпе.

В качестве шляпы возьмем phpStorm, прикрутим к нему phing, pear, некоторые 
дополнительные классы, и будем собирать наш архив прямо в проекте, и выкидывать
куда-нибудь во внешний мир.

Опять же, гитхаб предлагает специальный сервис по хостингу своих страничек. 
Вот туда и можно складировать архив при изменении версии.

### Лирическое отступление

В шторме есть довольно удачный механизм скриптовой обработки - phing. 
К сожалению, для нормальной работы этого самого механизма нужен pear и 
некоторые дополнительные прибамбасы. Опять же, к сожалению, разумно 
работать с встроенными в шторм возможностями, когда достаточно загрузить 
целый phar-пакет, не представляется возможным. Подгруженные phar отказываются 
работать как надо, так как задачи, которые используем мы, постоянно 
недозагружены в пакеты злодеями - разработчиками...

Однако, нам поможет тот же композер.

Стряпаем в отдельном месте нашего компьютера каталог pear, размещаем в нем файл composer.json

    {
        "repositories": [
            {
                "type": "pear",
                "url": "http://pear.php.net"
            }
        ],
        "require": {
            "phing/phing" : "2.6.1",
            "pear-pear.php.net/pear": "*",
            "pear/archive_tar" : "1.3.11"
        }
    }

Возможно с pear/archive_tar я погорячился, нам то нужен зип, да и предыдущая строчка его, 
по идее, установит сама, но нам на девелоперской машине считать место не с руки, лишь бы 
работало. А мне зачем-то эти тары бывают нужны...

Пишем в командной строке `composer update` и, через несколько минут, у нас появится почти 
нормальный pear с почти нормальным phing'ом. Почти - это если у вас, как и у меня, php не 
находится в пути доступа. В этом случае необходимо поправить файл
`vendor\phing\phing\bin\phing.bat` и поставить туда где-то в середину файла что-то вроде

    set PHP_COMMAND=d:\Winginx\php54\php.exe

Все! Указываем в настройках шторма `Phing->Path to Phing executable` этот самый файл и все 
должно жить долго и в меру счастливо...

## Что нам стоит архив в phing создать?

Да, в общем-то и ничего не стоит. Вот примерный файл build.xml, который разумно разместить 
в корне проекта. Если phing уже используется - достаточно стащить отсюда только задачу.

    <?xml version="1.0" encoding="utf-8"?>
    <project name="CEL" default="create TWIG archive">

        <target name="create TWIG archive" description="create TWIG archive">
            <delete file="../templater/ksnk.twig.zip"/>
            <zip destfile="../templater/ksnk.twig.zip">
                <fileset dir=".">
                    <include name="rpn_class.php" />
                </fileset>
                <fileset dir="samples/twig">
                    <include name="twig2php_class.php" />
                    <include name="tpl_compiler.php" />
                    <include name="template_compiler.php" />
                    <include name="tpl_base.php" />
                </fileset>
            </zip>
        </target>

    </project>

Как можно заметить, создается архив, котором с разных мест проекта набираются разные файлы. 
Не хватает только документации, но на этом пока сэкономим.

## Что делать клиенту?

Клиенту достаточно написать вот такое в своем composer.json

    "require": {
        "ksnk/twig":"dev-master"
    },
    "repositories": [
        {
            "type": "package",
            "package": {
                "name": "ksnk/twig",
                "version": "master",
                "dist": {
                    "url": "http://ksnk.github.io/templater/ksnk.twig.zip",
                    "type": "zip",
                    "reference": "master"
                },
                "autoload": {
                    "classmap": ["."]
                }
            }
        }
    ]

Вот и все. Нужно, конечно, подумать, что произойдет при смене версии нашей библиотеки, 
но это уже немного другая история.